import{J as d,v as R,K as B,aH as Q,au as V,n as j,bD as ee,bE as re,bF as H,T as x,bG as te,aE as ie}from"./8xvvzpeQ.js";import{s as G,f as K,l as p,O as _,P as M,g as ae,b as ne,a as se,A as oe,d as le}from"./oo_a1T_D.js";import{F as ue}from"./Cvp-3ycD.js";import{f as Y}from"./WnAHhi8M.js";const Se={base:{color:"#32325d",fontFamily:'"Helvetica Neue", Helvetica, sans-serif',fontSmoothing:"antialiased",fontSize:"16px","::placeholder":{color:"#aab7c4"}},invalid:{color:"#fa755a",iconColor:"#fa755a"}},we=(e,r,t)=>{let s=[];return{updatedProducts:e.map(a=>{if(a._id===t._id){if(r>a.max)return a.qty=a.qty,s.push(`A maximum of ${a.max} units of ${a.name} only can be purchased`),a;if(r>a.price.availableQuantity&&a.price.trackInventory&&!a.price.allowOutOfStockPurchases)return a.qty=a.qty,s.push(`Only ${a.price.availableQuantity} units of ${a.name} are in stock`),a;a.qty=r}return a}),errorMessages:s}},_e=e=>{var r,t,s;return((r=e==null?void 0:e.price)==null?void 0:r.availableQuantity)<=0&&((t=e==null?void 0:e.price)==null?void 0:t.trackInventory)&&!((s=e==null?void 0:e.price)!=null&&s.allowOutOfStockPurchases)},be=(e,r)=>r.find(t=>t._id===e.id),de=async({contactId:e,domain:r,pageUrl:t,locationId:s,productPreviewList:u,isCouponApplied:a,couponCode:n,couponSessionId:i,store:f,subType:g,traceId:b="",reCaptchaToken:S,isEcommercePurchase:I,shippingRateId:y,toZip:v,toState:o,toCountry:E,toCity:w,toStreetAddress:c,shippingCarrierRateId:N,note:k,separateBillingAddress:A})=>{var P,F,O,m;try{const h=d("msgsndr_id").value,L=d("am_id").value,J=d("am_fingerprint").value,q=f.funnelName||"funnel";r||(r=window.location.hostname,t=window.location.pathname);const{funnelPageId:W,funnelId:z,stepId:C}=f,T={altId:s,altType:"location",shippingRateId:y,shippingCarrierRateId:N,contactId:e,source:{type:f.pageType===_.FUNNEL?_.FUNNEL:_.WEBSITE,subType:g,id:z,name:q,meta:{stepId:C,pageId:W,domain:r,pageUrl:t,affiliateManager:{id:L,fingerprint:J}}},products:u.map(l=>({id:I?l.selectedPrice._id:l._id,qty:l.qty||l.quantity})),fingerprint:h,trackingId:B(),traceId:b,toZip:v,toState:o,toCountry:E,toCity:w,toStreetAddress:c,customerNote:k,separateBillingAddress:A};a&&(T.couponCode=n,T.couponSessionId=i),S&&(T.captchaToken=S);const U=await M.createOrder(T);if(!((P=U.order)==null?void 0:P._id))throw new Error("Something went wrong while creating order. Please try again later.");return U}catch(h){return console.error(h),{error:!0,message:(O=(F=h==null?void 0:h.response)==null?void 0:F._data)==null?void 0:O.message,status:(m=h==null?void 0:h.response)==null?void 0:m.status}}},ge=async(e,r,t,s,u,a,n)=>{var T,U,$;const i=d("msgsndr_id").value,f=d("am_id").value,g=d("am_fingerprint").value,b=ae(e.locationId),S=ne(e.locationId),I=se(),y=e.funnelName||"funnel";let{domain:v,page_url:o}=r.query;v||(v=window.location.hostname,o=window.location.pathname);const{funnelPageId:E,funnelId:w,stepId:c}=e,N={eventType:"optin",domainName:v,pageUrl:o,funnelId:w,pageId:E,stepId:c},{address:k,country:A,state:P,city:F,zipcode:O,fullName:m,phoneNumber:h,emailId:L,companyName:J}=t,q={addressLine1:k,country:A||s,state:P,city:F,zip:O};I.medium=oe.OrderForm,I.mediumId=N.stepId;const W=le();I.fbEventId=W;const z={lead:!0,eventData:I,source:y,pageId:E,funnelId:w,sessionId:b,funnelEventData:N,sessionFingerprint:S||null},C={locationId:e.locationId,name:m,phone:h,email:(L==null?void 0:L.toLowerCase())||"",companyName:J,address:q,attribution:z,timezone:ie(),amId:String(f),amFingerprint:g,orderFormType:"one_step_form_submission",captchaToken:u,billingAddress:n};a.enableStickyContact&&(C.attribution.fingerprint=i,C.attribution.funnelEventData.fingerprint=i),a.enableForceCreate&&(C.attribution.forceCreate=!0),a.enableEmailValidation&&(C.attribution.session_d=Number(a.enableEmailValidation)||0);try{const l=await ue.createContact(C);if(!l)throw new Error("Something went wrong. Please try again later.");if(l.fbEventId=W,i!==l.fingerprint){e.fingerprint=i;const D=d("msgsndr_id",{path:"/",maxAge:31536e3});D.value=l.fingerprint}B();const X=Q(l);V("_ud",X),j(()=>{Y("track","SubmitApplication")});let Z=l.sessionFingerprint;return I&&(G({sessionId:l.sessionId||null,locationId:e.locationId}),Z&&K(e.locationId,Z)),l}catch(l){return console.error(l),{error:!0,message:(U=(T=l==null?void 0:l.response)==null?void 0:T._data)==null?void 0:U.message,status:($=l==null?void 0:l.response)==null?void 0:$.status}}},Ee=async(e,r,t,s,u,a,n,i,f,g,b,S,I,y,v,o,E,w,c,N)=>{var k,A,P,F,O;if((!n||!n.id)&&(n=await ge(e,r,t,s,u,a,w),u=void 0),n!=null&&n.error){let m={};return(n==null?void 0:n.status)===429?(m={error:!0,processingPayment:!1,showRecaptcha:!0},m):(m={error:!0,processingPayment:!1,cardErrorMsg:n.message||"We're sorry, but something went wrong. Please try again"},m)}if((n.id&&!i||!((k=i==null?void 0:i.order)!=null&&k._id))&&(i=await de({contactId:n==null?void 0:n.id,domain:e.domain,pageUrl:e.pageUrl,locationId:e.locationId,productPreviewList:g,isCouponApplied:f,couponCode:S,couponSessionId:b,store:e,subType:y,traceId:n==null?void 0:n.traceId,reCaptchaToken:u,isEcommercePurchase:I,shippingRateId:v,toZip:(t==null?void 0:t.zipcode)??((A=t.address)==null?void 0:A.zip),toState:o,toCountry:(t==null?void 0:t.country)??((P=t.address)==null?void 0:P.country),toCity:(t==null?void 0:t.city)??((F=t.address)==null?void 0:F.city),toStreetAddress:((O=t.address)==null?void 0:O.addressLine1)??t.address,shippingCarrierRateId:E,note:c,separateBillingAddress:N}),u=void 0),i!=null&&i.error){let m={};return i.status===429?(m={error:!0,processingPayment:!1,showRecaptcha:!0,contactResponse:n},m):(m={error:!0,processingPayment:!1,contactResponse:n,cardErrorMsg:i.message||"We're sorry, but something went wrong. Please try again"},m)}return(i==null?void 0:i.success)===!1?{error:!0,cardErrorMsg:i==null?void 0:i.message,processingPayment:!1}:(sessionStorage.setItem("orderResponse",JSON.stringify(i)),y!=p.TWO_STEP_ORDER_FORM&&sessionStorage.setItem("contactResponse",JSON.stringify(n)),sessionStorage.setItem("orderResponse",JSON.stringify(i)),y!=p.TWO_STEP_ORDER_FORM&&sessionStorage.setItem("contactResponse",JSON.stringify(n)),sessionStorage.setItem("orderResponse",JSON.stringify(i)),y!=p.TWO_STEP_ORDER_FORM&&sessionStorage.setItem("contactResponse",JSON.stringify(n)),{contactResponse:n,orderResponse:i,reCaptchaToken:u})},me=(e,r,t,s)=>{if(B()!=(t==null?void 0:t.verifiedTrackingId)){const a=d("tr",{path:"/",maxAge:900});a.value=t==null?void 0:t.verifiedTrackingId}if(s!==p.TWO_STEP_ORDER_FORM){if(e.fingerprint!==r){const n=d("msgsndr_id",{path:"/",maxAge:31536e3});n.value=e.fingerprint}const a=Q(e);V("_ud",a)}if(e.fbEventId){let a=e.fbEventId;j(()=>{Y("track","OrderFormPurchase",a)})}else console.warn("Facebook event Id missing from attribution!")},Pe=async(e,r,t,s,u)=>{let a=!1,n="";if(r!=null&&r.message&&!(r!=null&&r.success))throw new Error(r.message);t===ee&&(r!=null&&r.pendingConfirmation)&&(a=!0,n="Order placed successfully! However your transaction is pending for review. Please contact the business owner");const i=d("msgsndr_id").value;await me(e,i,r,u);const f=d("provider");f.value=t===re?"pp":t===H?H:"cc",await fe({sessionId:e.sessionId,sessionFingerprint:r==null?void 0:r.sessionFingerprint},s);const g=sessionStorage.getItem("redirect");if(ce(s),g){sessionStorage.removeItem("redirect"),window.location.href=g;return}return{paymentResponseData:r,authorizeOrderPendingConfirmation:a,authorizeOrderAlertMsg:n}},fe=(e,r)=>{e&&e.sessionId&&(G({sessionId:e.sessionId||null,locationId:r}),e.sessionFingerprint&&K(r,e.sessionFingerprint))},Fe=e=>{var t;(!(e.keyCode>=48&&e.keyCode<=57||e.keyCode>=96&&e.keyCode<=105)||!/^\d{0,2}$/.test((t=e.target)==null?void 0:t.value))&&e.keyCode!==8&&e.preventDefault()},ce=e=>{const r=R();return sessionStorage.setItem(`couponSessionId_${e}`,r),r},Oe=async(e,r,t="",s=[],u,a,n,i,f,g=null)=>{var b,S,I,y,v;try{const o=x(),E=g?{_id:g._id,currency:g.currency,amount:g.amount}:null,w={altId:o.value.locationId,altType:"location",couponCode:t,source:{type:o.value.pageType===_.FUNNEL?_.FUNNEL:_.WEBSITE,subType:r,id:o.value.funnelId,name:o.value.funnelName,meta:{stepId:o.value.stepId,pageId:o.value.funnelPageId,domain:o.value.domain,pageUrl:o.value.pageUrl,affiliateManager:{id:d("am_id").value,fingerprint:d("msgsndr_id").value}}},shippingRate:E,products:e,toCountry:u,toState:a,toZip:n,toCity:i,toStreetAddress:f};s.length>0&&(w.giftCardCodes=s);const c=await M.getAmountSummary(w);return{total:c.summary.total,subtotal:c.summary.subtotal,taxSummary:c.summary.taxSummary,subtotalWithDiscount:c.summary.subtotalWithDiscount,futureRecurringPaymentAmount:(b=c.recurringSummary)==null?void 0:b.subtotalWithDiscount,additionalChargesSummary:c.summary.additionalChargesSummary,giftCards:c.summary.giftCards}}catch(o){return console.error(o),{error:!0,message:((I=(S=o==null?void 0:o.response)==null?void 0:S._data)==null?void 0:I.message)||"Something went wrong while fetching order total. Please try again later",status:(v=(y=o==null?void 0:o.response)==null?void 0:y._data)==null?void 0:v.status}}},Ce=async(e,r)=>{const t=await M.getLastPaymentMethodForTheCustomer({altId:e,altType:"location",contactId:r});return{paymentProvider:t==null?void 0:t.paymentProvider,paymentMethod:t==null?void 0:t.paymentMethod}},Te=async(e,r)=>await M.getLastSquarePaymentMethodForTheCustomer({altId:e,altType:"location",contactId:r}),Ne=(e,r,t,s)=>{const u=r<=0&&!t,a=t&&s<=0,n=u||a;return!!(e&&n||n)},ke=async()=>{const e=x();try{const r=await M.getStatesInformation();if(r&&r.error)throw te(r.error);e.value.countryList=(r==null?void 0:r.data)??[]}catch(r){console.error("Failed to fetch country list",r)}},Ae=e=>x().value.countryList.find(t=>t.code===e),Me=(e,r,t)=>{if(e.startsWith("+44")&&r.match(/^07\d*$/)){const s=e.replace("+44 1534","+44").replace("1534","");return window.libphonenumber.parsePhoneNumberFromString(s,"JE").formatInternational()}return t.formatInternational()},Le=async({couponCode:e,products:r,subType:t})=>{var s,u,a,n;try{const i=x(),f={altId:i.value.locationId,altType:"location",code:e,products:r,source:{type:i.value.pageType===_.FUNNEL?_.FUNNEL:_.WEBSITE,subType:t,id:i.value.funnelId,name:i.value.funnelName,meta:{stepId:i.value.stepId,pageId:i.value.funnelPageId,domain:i.value.domain,pageUrl:i.value.pageUrl,affiliateManager:{id:d("am_id").value,fingerprint:d("msgsndr_id").value}}}};return await M.verifyCoupon(f)}catch(i){return console.error(i),{error:!0,message:((u=(s=i==null?void 0:i.response)==null?void 0:s._data)==null?void 0:u.message)||"Something went wrong while verifying coupon. Please try again later",status:(n=(a=i==null?void 0:i.response)==null?void 0:a._data)==null?void 0:n.status}}};export{Oe as a,ke as b,ce as c,de as d,Te as e,Ce as f,Ae as g,Pe as h,Me as i,_e as j,be as k,we as l,Ee as m,Fe as n,Ne as p,Se as s,Le as v};
